import asyncio
import json
import os
from datetime import datetime

import aiohttp

import api_handler
from api_handler import fetch_clan_members_list, fetch_player_data
from database import process_clan_data, get_all_links, get_all_members, cleanup_old_warnings
from member_tracker import discord_sync_members_once
from role_giver import update_roles
from api_handler import fetch_current_war, fetch_current_capital
from clan_war import ClanWarHandler
from clan_capital import ClanCapitalHandler
from game_events import GameEventsHandler



# === Stav pozastaven√≠ hodinov√©ho updatu ===
is_hourly_paused = False

THIS_DIR = os.path.dirname(os.path.abspath(__file__))
ROOM_IDS_PATH = os.path.join(THIS_DIR, "discord_rooms_ids.json")
class RoomIdStorage:
    def __init__(self):
        self.data = {}
        self.load()

    def load(self):
        try:
            if os.path.exists(ROOM_IDS_PATH):
                with open(ROOM_IDS_PATH, "r") as f:
                    self.data = json.load(f)
        except Exception as e:
            print(f"[clan_war] [discord_rooms_ids] Chyba p≈ôi ƒçten√≠: {e}")
            self.data = {}

    def save(self):
        try:
            with open(ROOM_IDS_PATH, "w") as f:
                json.dump(self.data, f)
        except Exception as e:
            print(f"[clan_war] [discord_rooms_ids] Chyba p≈ôi z√°pisu: {e}")

    def get(self, key: str, default=None):
        return self.data.get(key, default)

    def set(self, key: str, value):
        self.data[key] = value
        self.save()

    def remove(self, key: str):
        if key in self.data:
            del self.data[key]
            self.save()

room_storage = RoomIdStorage()
# === Funkce pro hodinov√© tah√°n√≠ dat ===
async def hourly_clan_update(config: dict, bot):
    # Z√≠sk√°n√≠ nebo vytvo≈ôen√≠ ClanWarHandleru
    clan_war_handler = getattr(bot, "clan_war_handler", None)  # Pokus o z√≠sk√°n√≠ existuj√≠c√≠ho handleru z bot objektu
    current_cwl_round = room_storage.get("current_cwl_round") or 0  # Naƒçten√≠ aktu√°ln√≠ho kola CWL z √∫lo≈æi≈°tƒõ
    cwl_active = room_storage.get("cwl_active") or False  # Naƒçten√≠ stavu CWL z √∫lo≈æi≈°tƒõ
    cwl_group_data = None  # Inicializace promƒõnn√© pro data CWL skupiny

    # Pokud ClanWarHandler neexistuje, vytvo≈ô√≠me nov√Ω
    if clan_war_handler is None:
        clan_war_handler = ClanWarHandler(bot, config)  # Vytvo≈ôen√≠ nov√©ho handleru
        bot.clan_war_handler = clan_war_handler  # Ulo≈æen√≠ handleru do bot objektu pro budouc√≠ pou≈æit√≠
        game_events_handler = GameEventsHandler(bot, config)  # Vytvo≈ôen√≠ GameEventsHandleru (p≈Øvodn√≠ verze)

    # Z√≠sk√°n√≠ nebo vytvo≈ôen√≠ GameEventsHandleru (nov√°, robustnƒõj≈°√≠ verze)
    game_events_handler = getattr(bot, "game_events_handler", None)  # Pokus o z√≠sk√°n√≠ existuj√≠c√≠ho handleru
    if game_events_handler is None:
        game_events_handler = GameEventsHandler(bot, config)  # Vytvo≈ôen√≠ nov√©ho handleru
        bot.game_events_handler = game_events_handler  # Ulo≈æen√≠ handleru do bot objektu

    # Vytvo≈ôen√≠ handleru pro Clan Capital (v≈ædy nov√° instance)
    clan_capital_handler = ClanCapitalHandler(bot, config)

    # Hlavn√≠ smyƒçka
    while True:
        if not is_hourly_paused:
            print(
                f"üïí [Scheduler] spou≈°t√≠m hourly_clan_update Aktu√°ln√≠ datum a ƒças: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")

            # === Kontrola Discord u≈æivatel≈Ø ===
            try:
                await discord_sync_members_once(bot)
            except Exception as e:
                print(f"[scheduler] ‚ö†Ô∏è member sync chyba: {e}")

            # === Naƒçten√≠ guildy ===
            guild = bot.get_guild(config["GUILD_ID"])
            if guild is None:
                print(f"‚ùå [Scheduler] Guild s ID {config['GUILD_ID']} nebyl nalezen.")
                await asyncio.sleep(60)
                continue

            # === Naƒçten√≠ seznamu ƒçlen≈Ø klanu ===
            print("üîÅ [Scheduler] Spou≈°t√≠m aktualizaci seznamu ƒçlen≈Ø klanu...")
            try:
                data = await fetch_clan_members_list(config["CLAN_TAG"], config)
                if data:
                    print(f"‚úÖ [Scheduler] Naƒçteno {len(data.get('items', []))} ƒçlen≈Ø klanu.")
                    process_clan_data(data.get("items", []), bot=bot)
                else:
                    print("‚ö†Ô∏è [Scheduler] Nepoda≈ôilo se z√≠skat seznam ƒçlen≈Ø klanu.")
            except (aiohttp.ClientError, asyncio.TimeoutError) as e:
                print(f"‚ùå [Scheduler] Chyba p≈ôi naƒç√≠t√°n√≠ ƒçlen≈Ø klanu: {e}")
            except Exception as e:
                print(f"‚ùå [Scheduler] Neoƒçek√°van√° chyba p≈ôi fetch_clan_members_list: {e}")

            # === Aktualizace rol√≠ ===
            try:
                print("üîÑ [Scheduler] Spou≈°t√≠m automatickou aktualizaci rol√≠...")
                links = get_all_links()
                members = get_all_members()
                await update_roles(guild, links, members)
                print("‚úÖ [Scheduler] Aktualizace rol√≠ dokonƒçena.")
            except Exception as e:
                print(f"‚ùå [Scheduler] Chyba p≈ôi aktualizaci rol√≠: {e}")

            # === CAPITAL STATUS ===
            try:
                capital_data = await fetch_current_capital(config["CLAN_TAG"], config)
                if capital_data:
                    await clan_capital_handler.process_capital_data(capital_data)
            except (aiohttp.ClientError, asyncio.TimeoutError) as e:
                print(f"‚ùå [Scheduler] Chyba p≈ôi naƒç√≠t√°n√≠ capital dat: {e}")
            except Exception as e:
                print(f"‚ùå [Scheduler] Neoƒçek√°van√° chyba v CAPITAL ƒç√°sti: {e}")

            # === GAME EVENTS ===
            try:
                if 'game_events_handler' in locals():
                    await game_events_handler.process_game_events()
            except Exception as e:
                print(f"‚ùå [Scheduler] Chyba p≈ôi zpracov√°n√≠ game event≈Ø: {e}")

            # === VAROV√ÅN√ç ===
            try:
                await cleanup_old_warnings()
            except Exception as e:
                print(f"‚ùå [Scheduler] Chyba p≈ôi maz√°n√≠ varov√°n√≠: {e}")

            # === CLAN WAR and CLAN WAR LEAGUE ===
            try:
                # --- Norm√°ln√≠ v√°lky ---
                war_data = await api_handler.fetch_current_war(config["CLAN_TAG"], config)
                if war_data and war_data.get("state") in ("preparation", "inWar"):
                    await clan_war_handler.process_war_data(war_data)
                elif war_data and war_data.get("state") == "warEnded":
                    await clan_war_handler.process_war_data(war_data)
                else:
                    pass  # ≈æ√°dn√° aktivn√≠ war

                # --- CWL ---
                cwl_active = room_storage.get("cwl_active", False)
                current_round = room_storage.get("current_cwl_round", 0)

                if cwl_active:
                    group_data = await api_handler.fetch_league_group(config["CLAN_TAG"], config)
                    if not group_data:
                        print("[CWL] Data skupiny nedostupn√°, konƒç√≠m iteraci.")
                        return

                    rounds = group_data.get("rounds", [])
                    if current_round >= len(rounds):
                        # Bezpeƒçnostn√≠ reset pokud jsme mimo rozsah
                        print("[CWL] current_cwl_round >= poƒçet kol, resetuji.")
                        room_storage.set("cwl_active", False)
                        room_storage.set("current_cwl_round", 0)
                        return

                    war_tags = rounds[current_round].get("warTags", [])
                    active_found, ended_found = False, False

                    for tag in war_tags:
                        if tag == "#0":  # budouc√≠ kolo
                            continue
                        war = await api_handler.fetch_league_war(tag)
                        if not war:
                            continue

                        if war["clan"]["tag"] == config["CLAN_TAG"] or war["opponent"]["tag"] == config["CLAN_TAG"]:
                            await clan_war_handler.process_war_data(war, attacks_per_member=1)
                            state = war.get("state")
                            print(f"[CWL] round {current_round + 1} ‚Äì state: {state}")
                            if state in ("preparation", "inWar"):
                                active_found = True
                                break
                            elif state == "warEnded":
                                ended_found = True

                    if ended_found and not active_found:
                        new_round = current_round + 1
                        if new_round >= len(rounds):
                            print("[CWL] Dokonƒçena v≈°echna kola ‚Äì vyp√≠n√°m CWL.")
                            room_storage.set("cwl_active", False)
                            room_storage.set("current_cwl_round", 0)
                        else:
                            print(f"[CWL] P≈ôechod na dal≈°√≠ kolo: {new_round + 1}")
                            room_storage.set("current_cwl_round", new_round)

                else:
                    # Zkontroluj, zda zaƒç√≠n√° nov√° CWL sez√≥na
                    group_data = await api_handler.fetch_league_group(config["CLAN_TAG"])
                    if group_data and group_data.get("state") in ("preparation", "inWar"):
                        print("[CWL] Detekov√°n nov√Ω CWL, aktivuji.")
                        room_storage.set("cwl_active", True)
                        room_storage.set("current_cwl_round", 0)

            except Exception as e:
                print(f"[SCHEDULER] Chyba v CWL/war sekci: {e}")


        else:
            print("‚è∏Ô∏è [Scheduler] Aktualizace seznamu klanu je moment√°lnƒõ pozastavena kv≈Øli ovƒõ≈ôov√°n√≠.")

        await asyncio.sleep(60 * 3)  # ka≈æd√Ωch 5 minut

# === Funkce pro pozastaven√≠ hodinov√©ho updatu ===
def pause_hourly_update():
    """
    Nastav√≠ p≈ô√≠znak pro pozastaven√≠ hodinov√©ho updatu dat.
    """
    global is_hourly_paused
    is_hourly_paused = True
    print("‚è∏Ô∏è [scheduler] Hourly update byl pozastaven.")

# === Funkce pro obnoven√≠ hodinov√©ho updatu ===
def resume_hourly_update():
    """
    Vr√°t√≠ zpƒõt p≈ô√≠znak, aby hourly update znovu bƒõ≈æel.
    """
    global is_hourly_paused
    is_hourly_paused = False
    print("‚ñ∂Ô∏è [scheduler] Hourly update byl obnoven.")

# === Nov√° funkce pro verifikaƒçn√≠ smyƒçku ===
async def verification_check_loop(bot, player_tag, user, verification_channel, config):
    from verification import process_verification, end_verification

    print(f"üöÄ Zahajuji ovƒõ≈ôov√°n√≠ hr√°ƒçe {user} s tagem {player_tag}")
    pause_hourly_update()

    try:
        player_data = await fetch_player_data(player_tag, config)
        if not player_data:
            raise ValueError("Nepoda≈ôilo se naƒç√≠st data hr√°ƒçe")

        selected_item = await process_verification(bot, player_data, user, verification_channel)
        if not selected_item:
            raise ValueError("Nelze vybrat vybaven√≠ pro ovƒõ≈ôen√≠")

        # Hlavn√≠ smyƒçka ovƒõ≈ôov√°n√≠
        for try_num in range(1, 7):  # 6 pokus≈Ø
            await asyncio.sleep(300)

            player_data = await fetch_player_data(player_tag, config)
            if not player_data:
                continue

            result = await process_verification(bot, player_data, user, verification_channel, selected_item)
            if result == "verified":
                print(f"‚úÖ Hr√°ƒç {user} √∫spƒõ≈°nƒõ ovƒõ≈ôen")
                return  # Ukonƒç√≠ funkci, end_verification se zavol√° v succesful_verification

        # Timeout po 6 pokusech
        await verification_channel.send("‚ùå ƒåasov√Ω limit pro ovƒõ≈ôen√≠ vypr≈°el")
        raise TimeoutError("Vypr≈°el ƒçasov√Ω limit pro ovƒõ≈ôen√≠")

    except Exception as e:
        print(f"‚ùå Chyba p≈ôi ovƒõ≈ôov√°n√≠ {user}: {e}")
    finally:
        # V≈ædy uklid√≠me, i kdy≈æ dojde k chybƒõ
        await end_verification(user, verification_channel)
        resume_hourly_update()
